name: Release Build (tag-triggered)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build (e.g., v2.3.13)'
        required: false

permissions:
  contents: write
  id-token: write
  actions: read

jobs:
  build-and-upload:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    env:
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print Git info
        run: |
          echo "GITHUB_REF=${GITHUB_REF}"
          echo "GITHUB_SHA=${GITHUB_SHA}"
          echo "HEAD: $(git rev-parse HEAD)"
          git --no-pager log -1 --pretty=fuller

      - name: Ensure tag context when uploading
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') == false
        run: |
          echo "This job only uploads on tag pushes. Ref: ${GITHUB_REF}";
          exit 1

      - name: Show package.json version
        run: |
          node -v || true
          echo "package.json version: $(node -p "require('./package.json').version")"

      - name: Node install
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build packages
        run: |
          echo "Building on $RUNNER_OS"
          if [ "$RUNNER_OS" = "Windows" ] || [ "${{ matrix.os }}" = "windows-latest" ]; then
            npx electron-builder --win --x64 --publish=never
          elif [ "$RUNNER_OS" = "macOS" ] || [ "${{ matrix.os }}" = "macos-latest" ]; then
            npx electron-builder --mac --publish=never
          else
            npx electron-builder --linux --publish=never
          fi
        shell: bash

      - name: List dist
        run: |
          echo "--- dist contents ---"
          ls -la dist || true
        shell: bash

      - name: Compute checksums
        run: |
          if [ -d dist ]; then
            echo "Found dist; computing sha256s:"
            for f in dist/*; do
              if [ -f "$f" ]; then sha256sum "$f"; fi
            done
          else
            echo "No dist directory found"
          fi

      - name: Upload built artifacts to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # If manually dispatched, allow overriding tag input
          if [ -n "${INPUT_TAG}" ]; then TAG="${INPUT_TAG}"; fi

          echo "Resolved release tag: $TAG"
          # Verify package.json version matches tag (safety)
          PKG_VERSION=$(node -p "require('./package.json').version")
          PKG_TAG="v${PKG_VERSION}"
          if [ "$TAG" != "$PKG_TAG" ]; then
            echo "ERROR: Release tag $TAG does not match package.json version $PKG_TAG. Aborting upload."; exit 1
          fi

          # Ensure release exists or create it
          gh release view "$TAG" --repo "$REPO" >/dev/null 2>&1 || gh release create "$TAG" --notes "CI artifacts for $TAG" --repo "$REPO"

          files_to_upload=(dist/*)
          echo "Files to upload: ${files_to_upload[*]}"
          failures=()
          for file in "${files_to_upload[@]}"; do
            if [ -f "$file" ]; then
              echo "Uploading $file..."
              gh release upload "$TAG" "$file" --clobber --repo "$REPO" || failures+=("$file")
            fi
          done

          if [ ${#failures[@]} -ne 0 ]; then
            echo "Failed uploads: ${failures[*]}"; exit 1
          fi
        shell: bash

      - name: Post-upload checks
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view ${GITHUB_REF#refs/tags/} --repo $REPO --json tagName,assets | jq '.assets | map({name: .name, size: .size})'
        shell: bash
